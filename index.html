<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Petrol Fill-up Tracker</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }

        .screen {
            display: none;
        }

        .active-screen {
            display: block;
        }

        .hidden {
            display: none;
        }

        /* Simple spinner animation */
        .spinner {
            border: 4px solid rgba(0, 0, 0, 0.1);
            width: 36px;
            height: 36px;
            border-radius: 50%;
            border-left-color: #09f;
            animation: spin 1s ease infinite;
        }

        @keyframes spin {
            0% {
                transform: rotate(0deg);
            }

            100% {
                transform: rotate(360deg);
            }
        }
    </style>
    <script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-6543766655734187"
        crossorigin="anonymous"></script>
    <meta name="google-adsense-account" content="ca-pub-6543766655734187">
</head>

<body class="bg-gray-50 text-gray-800">

    <div id="app-container" class="max-w-lg mx-auto p-4 md:p-6 min-h-screen">

        <!-- Login / Sign Up Screen -->
        <section id="auth-screen" class="screen">
            <div class="mt-12">
                <h1 class="text-3xl font-bold text-gray-900 text-center">Welcome!</h1>
                <p class="text-center text-gray-500 mb-8">Login or create an account to track your petrol fill-ups.</p>
                <div class="bg-white p-6 rounded-xl shadow-md border border-gray-200">
                    <div class="space-y-4">
                        <div>
                            <label for="email" class="block text-sm font-medium text-gray-700">Email Address</label>
                            <input type="email" id="email" autocomplete="email"
                                class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 sm:text-sm">
                        </div>
                        <div>
                            <label for="password" class="block text-sm font-medium text-gray-700">Password</label>
                            <input type="password" id="password" autocomplete="current-password"
                                class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 sm:text-sm">
                        </div>
                    </div>
                    <div class="mt-6 flex flex-col sm:flex-row gap-3">
                        <button id="login-btn"
                            class="flex-1 py-2 px-4 border border-transparent rounded-md shadow-sm text-sm font-medium text-white bg-blue-600 hover:bg-blue-700">Login</button>
                        <button id="signup-btn"
                            class="flex-1 py-2 px-4 border border-gray-300 rounded-md shadow-sm text-sm font-medium text-gray-700 bg-white hover:bg-gray-50">Sign
                            Up</button>
                    </div>
                </div>
            </div>
        </section>


        <!-- Main Application Screen -->
        <div id="main-app" class="hidden">
            <!-- Header and Navigation -->
            <header class="mb-6">
                <div class="flex justify-between items-center mb-1">
                    <h1 class="text-3xl font-bold text-gray-900">Petrol Fill-up Tracker</h1>
                    <button id="logout-btn"
                        class="text-sm text-blue-600 hover:text-blue-800 font-semibold">Logout</button>
                </div>
                <p class="text-gray-500">Record your petrol fill-ups easily.</p>
                <nav class="mt-4 flex justify-center bg-gray-200 rounded-lg p-1">
                    <button id="nav-home"
                        class="nav-btn flex-1 py-2 px-4 text-sm font-semibold rounded-md transition-colors bg-white text-blue-600 shadow">Add
                        Fill-up</button>
                    <button id="nav-history"
                        class="nav-btn flex-1 py-2 px-4 text-sm font-semibold rounded-md transition-colors text-gray-600">History</button>
                    <button id="nav-summary"
                        class="nav-btn flex-1 py-2 px-4 text-sm font-semibold rounded-md transition-colors text-gray-600">Summary</button>
                </nav>
            </header>

            <main>
                <!-- Home Screen: Record Fill-up (Simplified) -->
                <section id="home-screen" class="screen active-screen">
                    <div class="bg-white p-6 rounded-xl shadow-md border border-gray-200 text-center">
                        <h2 class="text-xl font-semibold mb-4">Upload Receipt for Fill-up</h2>
                        <label for="receipt-upload"
                            class="flex flex-col items-center justify-center w-full h-48 border-2 border-dashed border-gray-300 rounded-lg cursor-pointer bg-gray-50 hover:bg-gray-100 transition-colors mb-4">
                            <div class="flex flex-col items-center justify-center pt-5 pb-6">
                                <svg class="w-10 h-10 mb-3 text-gray-400" fill="none" stroke="currentColor"
                                    viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                        d="M7 16a4 4 0 01-4-4V7a4 4 0 014-4h10a4 4 0 014 4v5a4 4 0 01-4 4H7z"></path>
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                        d="M16 16v-2a2 2 0 00-2-2H10a2 2 0 00-2 2v2m-6 4h12m-6-4v4"></path>
                                </svg>
                                <p class="mb-2 text-sm text-gray-500"><span class="font-semibold">Click to upload
                                        receipt</span> or drag and drop</p>
                                <p class="text-xs text-gray-500">PNG, JPG (MAX. 5MB)</p>
                            </div>
                            <input id="receipt-upload" type="file" class="hidden" accept="image/png, image/jpeg" />
                        </label>
                        <p id="file-name" class="text-center text-sm text-gray-500 mt-2"></p>
                    </div>
                </section>

                <!-- Processing Screen -->
                <section id="processing-screen" class="screen">
                    <div class="bg-white p-8 rounded-xl shadow-md border border-gray-200 text-center">
                        <div class="spinner mx-auto mb-4"></div>
                        <h2 class="text-xl font-semibold">Reading Receipt...</h2>
                        <p class="text-gray-500">Extracting details, please wait.</p>
                    </div>
                </section>

                <!-- Confirmation Screen -->
                <section id="confirmation-screen" class="screen">
                    <div class="bg-white p-6 rounded-xl shadow-md border border-gray-200">
                        <h2 class="text-xl font-semibold mb-4">Confirm Fill-up Details</h2>
                        <p class="text-sm text-gray-600 mb-4">The AI has extracted the details. Please confirm and edit
                            if necessary before saving.</p>
                        <div class="space-y-4">
                            <div>
                                <label for="confirm-petrol-station-name"
                                    class="block text-sm font-medium text-gray-700">Petrol Station Name</label>
                                <input type="text" id="confirm-petrol-station-name"
                                    class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 sm:text-sm"
                                    placeholder="Petrol Station Name">
                            </div>
                            <div>
                                <label for="confirm-petrol-station-location"
                                    class="block text-sm font-medium text-gray-700">Petrol Station Location</label>
                                <input type="text" id="confirm-petrol-station-location"
                                    class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 sm:text-sm"
                                    placeholder="Petrol Station Location">
                            </div>
                            <div>
                                <label for="confirm-fuel-type" class="block text-sm font-medium text-gray-700">Fuel
                                    Type</label>
                                <!-- Changed from select to text input for detailed fuel types -->
                                <input type="text" id="confirm-fuel-type"
                                    class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 sm:text-sm"
                                    placeholder="e.g., Shell V-Power ULD">
                            </div>
                            <div>
                                <label for="confirm-litres-filled"
                                    class="block text-sm font-medium text-gray-700">Litres Filled</label>
                                <input type="number" step="0.01" id="confirm-litres-filled"
                                    class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 sm:text-sm"
                                    placeholder="Litres Filled">
                            </div>
                            <div>
                                <label for="confirm-price-per-litre"
                                    class="block text-sm font-medium text-gray-700">Price Per Litre (£)</label>
                                <input type="number" step="0.001" id="confirm-price-per-litre"
                                    class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 sm:text-sm"
                                    placeholder="Price Per Litre">
                            </div>
                            <div>
                                <label for="confirm-total-cost" class="block text-sm font-medium text-gray-700">Total
                                    Cost (£)</label>
                                <input type="number" step="0.01" id="confirm-total-cost"
                                    class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 sm:text-sm"
                                    placeholder="Total Cost">
                            </div>
                            <div>
                                <label for="confirm-odometer-reading"
                                    class="block text-sm font-medium text-gray-700">Odometer Reading (miles/km)</label>
                                <input type="number" step="1" id="confirm-odometer-reading"
                                    class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 sm:text-sm"
                                    placeholder="Odometer Reading">
                            </div>
                            <div>
                                <label for="confirm-date" class="block text-sm font-medium text-gray-700">Date</label>
                                <input type="date" id="confirm-date"
                                    class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 sm:text-sm">
                            </div>
                            <div>
                                <label for="confirm-time" class="block text-sm font-medium text-gray-700">Time</label>
                                <input type="time" id="confirm-time"
                                    class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 sm:text-sm">
                            </div>
                        </div>
                        <div class="mt-6 flex justify-end space-x-3">
                            <button id="cancel-confirm-btn"
                                class="py-2 px-4 border border-gray-300 rounded-md shadow-sm text-sm font-medium text-gray-700 bg-white hover:bg-gray-50">Edit</button>
                            <button id="save-confirmed-btn"
                                class="py-2 px-4 border border-transparent rounded-md shadow-sm text-sm font-medium text-white bg-blue-600 hover:bg-blue-700">Save
                                Fill-up</button>
                        </div>
                    </div>
                </section>

                <!-- History Screen -->
                <section id="history-screen" class="screen">
                    <div class="flex flex-col sm:flex-row gap-4 mb-4">
                        <div class="flex-grow">
                            <label for="sort-by" class="block text-sm font-medium text-gray-700">Sort by</label>
                            <select id="sort-by"
                                class="mt-1 block w-full pl-3 pr-10 py-2 text-base border-gray-300 focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm rounded-md">
                                <option value="date-desc">Date (Newest First)</option>
                                <option value="date-asc">Date (Oldest First)</option>
                                <option value="total-desc">Total Cost (High to Low)</option>
                                <option value="total-asc">Total Cost (Low to High)</option>
                                <option value="litres-desc">Litres (High to Low)</option>
                                <option value="litres-asc">Litres (Low to High)</option>
                                <option value="odometer-desc">Odometer (High to Low)</option>
                                <option value="odometer-asc">Odometer (Low to High)</option>
                            </select>
                        </div>
                        <div class="flex-shrink-0 self-end">
                            <button id="export-btn"
                                class="w-full py-2 px-4 border border-transparent rounded-md shadow-sm text-sm font-medium text-white bg-green-600 hover:bg-green-700">Export
                                to Excel</button>
                        </div>
                    </div>
                    <div id="history-list" class="space-y-3">
                        <!-- History items will be injected here -->
                    </div>
                </section>

                <!-- Summary Screen -->
                <section id="summary-screen" class="screen">
                    <div class="bg-white p-6 rounded-xl shadow-md border border-gray-200">
                        <h2 class="text-xl font-semibold mb-2">Fill-up Summary</h2>
                        <div class="mb-4 flex justify-center bg-gray-100 rounded-lg p-1">
                            <button id="filter-1m"
                                class="filter-btn flex-1 py-2 px-4 text-sm font-semibold rounded-md transition-colors">1
                                Month</button>
                            <button id="filter-2m"
                                class="filter-btn flex-1 py-2 px-4 text-sm font-semibold rounded-md transition-colors">2
                                Months</button>
                            <button id="filter-3m"
                                class="filter-btn flex-1 py-2 px-4 text-sm font-semibold rounded-md transition-colors">3
                                Months</button>
                        </div>

                        <div id="summary-details" class="hidden">
                            <div class="mb-4 text-center">
                                <p class="text-gray-600">Total Cost in Period:</p>
                                <p id="summary-total" class="text-3xl font-bold text-gray-900">£0.00</p>
                                <p class="text-gray-600">Total Litres Filled:</p>
                                <p id="summary-litres" class="text-3xl font-bold text-gray-900">0.00 L</p>
                            </div>
                            <div class="mb-4 flex justify-center bg-gray-100 rounded-lg p-1">
                                <button id="chart-by-station"
                                    class="chart-toggle-btn flex-1 py-2 px-4 text-sm font-semibold rounded-md transition-colors">By
                                    Station</button>
                                <button id="chart-by-fuel-type"
                                    class="chart-toggle-btn flex-1 py-2 px-4 text-sm font-semibold rounded-md transition-colors">By
                                    Fuel Type</button>
                            </div>
                            <div id="summary-list" class="mt-4 space-y-2">
                                <!-- Per-station/fuel-type summary will be injected here -->
                            </div>
                            <hr class="my-4">
                        </div>

                        <div id="chart-container" class="relative h-80">
                            <canvas id="fillup-chart"></canvas>
                            <div id="no-chart-data" class="hidden absolute inset-0 flex items-center justify-center">
                                <p class="text-gray-500">No fill-up data for this period.</p>
                            </div>
                        </div>
                    </div>
                </section>
            </main>
        </div>
    </div>

    <!-- Alert Modal -->
    <div id="alert-modal" class="fixed inset-0 bg-gray-800 bg-opacity-75 flex items-center justify-center p-4 z-50"
        style="display: none;">
        <div class="bg-white rounded-lg shadow-xl p-6 w-full max-w-sm text-center">
            <p id="alert-modal-message" class="text-lg mb-4"></p>
            <button id="alert-modal-close-btn"
                class="bg-blue-600 text-white py-2 px-6 rounded-md hover:bg-blue-700">OK</button>
        </div>
    </div>

    <!-- Detail Modal -->
    <div id="detail-modal" class="fixed inset-0 bg-gray-800 bg-opacity-75 flex items-center justify-center p-4 z-50"
        style="display: none;">
        <div class="bg-white rounded-lg shadow-xl w-full max-w-md">
            <div class="p-6">
                <h3 class="text-xl font-semibold mb-4" id="detail-modal-title">Fill-up Details</h3>
                <div id="detail-modal-content" class="max-h-80 overflow-y-auto space-y-2 pr-2 text-gray-700">
                    <!-- Fill-up details will be injected here -->
                </div>
            </div>
            <div class="bg-gray-100 px-6 py-3 flex justify-end">
                <button id="detail-modal-close-btn"
                    class="bg-gray-600 text-white py-2 px-6 rounded-md hover:bg-gray-700">Close</button>
            </div>
        </div>
    </div>

    <!-- Delete Confirmation Modal -->
    <div id="delete-confirm-modal"
        class="fixed inset-0 bg-gray-800 bg-opacity-75 flex items-center justify-center p-4 z-50"
        style="display: none;">
        <div class="bg-white rounded-lg shadow-xl p-6 w-full max-w-sm text-center">
            <h3 class="text-lg font-semibold mb-2">Are you sure?</h3>
            <p id="delete-confirm-message" class="text-gray-600 mb-6">This fill-up will be permanently deleted. This
                action cannot be undone.</p>
            <div class="flex justify-center space-x-4">
                <button id="delete-cancel-btn"
                    class="flex-1 py-2 px-4 border border-gray-300 rounded-md shadow-sm text-sm font-medium text-gray-700 bg-white hover:bg-gray-50">Cancel</button>
                <button id="delete-confirm-btn"
                    class="flex-1 py-2 px-4 border border-transparent rounded-md shadow-sm text-sm font-medium text-white bg-red-600 hover:bg-red-700">Delete</button>
            </div>
        </div>
    </div>


    <script type="module">
        // Firebase Imports
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged, createUserWithEmailAndPassword, signInWithEmailAndPassword, signOut } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, addDoc, onSnapshot, query, doc, deleteDoc, getDocs } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // --- App State ---
        let db;
        let auth;
        let userId;
        let isAuthReady = false;
        let unsubscribeHistory = null;
        let fillupIdToDelete = null;
        let allFillups = [];
        let fillupChart = null;
        let currentSort = 'date-desc';
        let currentChartType = 'station';
        let currentExtractedDetails = null; // To store AI extracted data
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';

        // --- UI Elements ---
        const authScreen = document.getElementById('auth-screen');
        const mainApp = document.getElementById('main-app');
        const emailInput = document.getElementById('email');
        const passwordInput = document.getElementById('password');
        const loginBtn = document.getElementById('login-btn');
        const signupBtn = document.getElementById('signup-btn');
        const logoutBtn = document.getElementById('logout-btn');

        const mainAppScreens = document.querySelectorAll('#main-app .screen');
        const navBtns = document.querySelectorAll('.nav-btn');
        const homeNavBtn = document.getElementById('nav-home');
        const historyNavBtn = document.getElementById('nav-history');
        const summaryNavBtn = document.getElementById('nav-summary');

        // Receipt upload elements
        const receiptUploadInput = document.getElementById('receipt-upload');
        const fileNameDisplay = document.getElementById('file-name');

        // New fill-up specific inputs (on home screen) - these are now removed from HTML, but variables remain for resetForm
        // These variables are kept for the `resetForm` function to avoid errors, even if the elements are not in the DOM.
        const petrolStationNameInput = document.getElementById('petrol-station-name');
        const petrolStationLocationInput = document.getElementById('petrol-station-location');
        const fuelTypeInput = document.getElementById('fuel-type');
        const litresFilledInput = document.getElementById('litres-filled');
        const pricePerLitreInput = document.getElementById('price-per-litre');
        const totalCostInput = document.getElementById('total-cost');
        const odometerReadingInput = document.getElementById('odometer-reading');
        const dateInput = document.getElementById('date');
        const timeInput = document.getElementById('time');

        const saveBtn = document.getElementById('save-btn'); // This button is removed from HTML

        const historyList = document.getElementById('history-list');
        const sortBySelect = document.getElementById('sort-by');
        const exportBtn = document.getElementById('export-btn');

        const alertModal = document.getElementById('alert-modal');
        const alertModalMessage = document.getElementById('alert-modal-message');
        const alertModalCloseBtn = document.getElementById('alert-modal-close-btn');

        const detailModal = document.getElementById('detail-modal');
        const detailModalTitle = document.getElementById('detail-modal-title');
        const detailModalContent = document.getElementById('detail-modal-content');
        const detailModalCloseBtn = document.getElementById('detail-modal-close-btn');

        const deleteConfirmModal = document.getElementById('delete-confirm-modal');
        const deleteConfirmBtn = document.getElementById('delete-confirm-btn');
        const deleteCancelBtn = document.getElementById('delete-cancel-btn');

        // Confirmation screen elements (for displaying AI extracted data)
        const confirmPetrolStationNameInput = document.getElementById('confirm-petrol-station-name');
        const confirmPetrolStationLocationInput = document.getElementById('confirm-petrol-station-location');
        const confirmFuelTypeInput = document.getElementById('confirm-fuel-type');
        const confirmLitresFilledInput = document.getElementById('confirm-litres-filled');
        const confirmPricePerLitreInput = document.getElementById('confirm-price-per-litre');
        const confirmTotalCostInput = document.getElementById('confirm-total-cost');
        const confirmOdometerReadingInput = document.getElementById('confirm-odometer-reading');
        const confirmDateInput = document.getElementById('confirm-date');
        const confirmTimeInput = document.getElementById('confirm-time');
        const cancelConfirmBtn = document.getElementById('cancel-confirm-btn');
        const saveConfirmedBtn = document.getElementById('save-confirmed-btn');

        const summaryDetails = document.getElementById('summary-details');
        const summaryTotalEl = document.getElementById('summary-total');
        const summaryLitresEl = document.getElementById('summary-litres');
        const summaryListEl = document.getElementById('summary-list');
        const chartContainer = document.getElementById('chart-container');
        const noChartData = document.getElementById('no-chart-data');
        const chartCanvas = document.getElementById('fillup-chart');
        const filterBtns = document.querySelectorAll('.filter-btn');
        const chartToggleBtns = document.querySelectorAll('.chart-toggle-btn');


        // Your web app's Firebase configuration
        // For Firebase JS SDK v7.20.0 and later, measurementId is optional
        const firebaseConfig = {
            apiKey: "AIzaSyD9U3RzDKV_ZUK8_groLt0x9KxzmoLnjGw",
            authDomain: "petrolfilluptracker.firebaseapp.com",
            projectId: "petrolfilluptracker",
            storageBucket: "petrolfilluptracker.firebasestorage.app",
            messagingSenderId: "1040000770286",
            appId: "1:1040000770286:web:063ee98f41b69cf990d3ff",
            measurementId: "G-1PHPSQC11Z"
        };

        // --- Utility Functions ---
        function showMainAppScreen(screenId) {
            mainAppScreens.forEach(screen => {
                screen.classList.toggle('active-screen', screen.id === screenId);
            });
            if (screenId === 'history-screen' && isAuthReady) {
                fetchAndDisplayHistory();
            } else if (screenId === 'summary-screen' && isAuthReady) {
                loadSummaryData();
            } else if (unsubscribeHistory) {
                unsubscribeHistory();
                unsubscribeHistory = null;
            }
        }

        function updateNav(activeBtnId) {
            navBtns.forEach(btn => {
                btn.classList.toggle('bg-white', btn.id === activeBtnId);
                btn.classList.toggle('text-blue-600', btn.id === activeBtnId);
                btn.classList.toggle('shadow', btn.id === activeBtnId);
                btn.classList.toggle('text-gray-600', btn.id !== activeBtnId);
            });
        }

        function showModal(message, type = 'alert') {
            if (type === 'alert') {
                alertModalMessage.textContent = message;
                alertModal.style.display = 'flex';
            } else if (type === 'detail') {
                detailModal.style.display = 'flex';
            } else if (type === 'deleteConfirm') {
                deleteConfirmModal.style.display = 'flex';
            }
        }

        function hideModal(type = 'alert') {
            if (type === 'alert') {
                alertModal.style.display = 'none';
            } else if (type === 'detail') {
                detailModal.style.display = 'none';
            } else if (type === 'deleteConfirm') {
                deleteConfirmModal.style.display = 'none';
            }
        }

        // --- Authentication Logic ---
        const handleSignUp = async () => {
            const email = emailInput.value;
            const password = passwordInput.value;
            if (!email || !password) {
                showModal("Please enter an email and password.");
                return;
            }
            try {
                await createUserWithEmailAndPassword(auth, email, password);
            } catch (error) {
                if (error.code === 'auth/operation-not-allowed') {
                    showModal("Sign-Up Blocked. Please enable Email/Password sign-in in your Firebase project's Authentication settings.");
                } else {
                    showModal(`Sign up failed: ${error.message}`);
                }
                console.error("Sign up error:", error);
            }
        };

        const handleLogin = async () => {
            const email = emailInput.value;
            const password = passwordInput.value;
            if (!email || !password) {
                showModal("Please enter an email and password.");
                return;
            }
            try {
                await signInWithEmailAndPassword(auth, email, password);
            } catch (error) {
                if (error.code === 'auth/operation-not-allowed') {
                    showModal("Login Blocked. Please ensure 'Email/Password' sign-in is enabled in your Firebase project's Authentication settings.");
                } else {
                    showModal(`Login failed: ${error.message}`);
                }
                console.error("Login error:", error);
            }
        };

        const handleLogout = async () => {
            try {
                await signOut(auth);
            } catch (error) {
                showModal(`Logout failed: ${error.message}`);
                console.error("Logout error:", error);
            }
        };

        // --- AI Receipt Reading Logic ---
        function toBase64(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.readAsDataURL(file);
                reader.onload = () => resolve(reader.result.split(',')[1]);
                reader.onerror = error => reject(error);
            });
        }

        async function handleFileUpload(event) {
            const file = event.target.files[0];
            if (!file) return;

            fileNameDisplay.textContent = `Selected: ${file.name}`;
            showMainAppScreen('processing-screen');

            try {
                const base64Image = await toBase64(file);
                await extractDataFromImage(base64Image);
            } catch (error) {
                console.error("Error processing file:", error);
                showModal("Could not process the image. Please try again.");
                showMainAppScreen('home-screen');
            }
            receiptUploadInput.value = ''; // Clear the file input
        }

        async function extractDataFromImage(base64ImageData) {
            const prompt = `
                Analyze this petrol receipt image. Extract the following details:
                - petrolStationName (string, e.g., "Shell", "BP")
                - petrolStationLocation (string, e.g., "Surbiton", "London")
                - fuelType (string, standardize to common names. For example, "Shell V-Power ULD", "Shell V-Power Unleaded", "V-Power Unleaded" should all become "V-Power Unleaded". "Esso Synergy Supreme+", "Esso Synergy Supreme Diesel" should become "Synergy Supreme". "Unleaded 95", "Unleaded" should become "Unleaded 95". "Diesel", "Regular Diesel" should become "Diesel". If a specific brand/variant is present, prioritize that, otherwise use general terms like "Petrol", "Diesel", "Electric", "Other". Ensure the output is concise and standardized.)
                - litresFilled (number, e.g., 45.50)
                - pricePerLitre (number, e.g., 1.599)
                - totalCost (number, e.g., 72.75)
                - odometerReading (number, e.g., 123456) - If not explicitly on receipt, infer from common patterns or leave null.
                - date (string, YYYY-MM-DD)
                - time (string, HH:MM)

                Return a single JSON object with these keys. If a value cannot be found, use null or an empty string for strings, and 0 for numbers, but try your best to extract.
            `;
            const payload = {
                contents: [{ parts: [{ text: prompt }, { inlineData: { mimeType: "image/jpeg", data: base64ImageData } }] }],
                generationConfig: { "responseMimeType": "application/json" }
            };
            const apiKey = ""; // API key will be provided by Canvas runtime
            const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key=${apiKey}`;

            try {
                const response = await fetch(apiUrl, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload) });
                if (!response.ok) throw new Error(`API call failed: ${response.status}`);
                const result = await response.json();

                if (result.candidates && result.candidates[0].content && result.candidates[0].content.parts[0]) {
                    const data = JSON.parse(result.candidates[0].content.parts[0].text);
                    currentExtractedDetails = data; // Store extracted data
                    populateConfirmationScreen(data);
                    showMainAppScreen('confirmation-screen');
                } else {
                    throw new Error("Invalid response structure from Gemini API.");
                }
            } catch (error) {
                console.error("Error calling Gemini API:", error);
                showModal("Failed to read the receipt. Please try another image or enter details manually.");
                resetForm(); // Reset home screen form
                showMainAppScreen('home-screen'); // Go back to home screen for manual input
            }
        }

        function populateConfirmationScreen(data) {
            confirmPetrolStationNameInput.value = data.petrolStationName || '';
            confirmPetrolStationLocationInput.value = data.petrolStationLocation || '';
            confirmFuelTypeInput.value = data.fuelType || '';
            confirmLitresFilledInput.value = data.litresFilled || '';
            confirmPricePerLitreInput.value = data.pricePerLitre || '';
            confirmTotalCostInput.value = data.totalCost || '';
            confirmOdometerReadingInput.value = data.odometerReading || '';
            confirmDateInput.value = data.date || new Date().toISOString().split('T')[0];
            confirmTimeInput.value = data.time || '';
        }

        async function saveFillup() {
            if (!isAuthReady) { showModal("Authentication not ready. Please wait."); return; }

            const fillupData = {
                petrolStationName: confirmPetrolStationNameInput.value.trim() || 'Unknown Station',
                petrolStationLocation: confirmPetrolStationLocationInput.value.trim(),
                fuelType: confirmFuelTypeInput.value.trim() || 'Other',
                litresFilled: parseFloat(confirmLitresFilledInput.value) || 0,
                pricePerLitre: parseFloat(confirmPricePerLitreInput.value) || 0,
                totalCost: parseFloat(confirmTotalCostInput.value) || 0,
                odometerReading: parseInt(confirmOdometerReadingInput.value) || 0,
                date: confirmDateInput.value,
                time: confirmTimeInput.value,
                createdAt: new Date().toISOString()
            };

            // Validate inputs
            if (!fillupData.petrolStationName || isNaN(fillupData.litresFilled) || isNaN(fillupData.pricePerLitre) || isNaN(fillupData.totalCost) || !fillupData.date || isNaN(fillupData.odometerReading)) {
                showModal("Please fill in Petrol Station Name, Litres, Price, Total Cost, Odometer Reading, and Date with valid values.");
                return;
            }

            try {
                await addDoc(collection(db, `artifacts/${appId}/users/${userId}/fillups`), fillupData);
                showModal("Fill-up saved successfully!");
                resetForm();
                showMainAppScreen('home-screen');
                updateNav('nav-home');
            } catch (error) {
                console.error("Error saving fill-up: ", error);
                showModal("Could not save the fill-up. Please try again.");
            }
        }

        function resetForm() {
            if (petrolStationNameInput) petrolStationNameInput.value = '';
            if (petrolStationLocationInput) petrolStationLocationInput.value = '';
            if (fuelTypeInput) fuelTypeInput.value = '';
            if (litresFilledInput) litresFilledInput.value = '';
            if (pricePerLitreInput) pricePerLitreInput.value = '';
            if (totalCostInput) totalCostInput.value = '';
            if (odometerReadingInput) odometerReadingInput.value = '';
            if (dateInput) dateInput.value = '';
            if (timeInput) timeInput.value = '';

            confirmPetrolStationNameInput.value = '';
            confirmPetrolStationLocationInput.value = '';
            confirmFuelTypeInput.value = '';
            confirmLitresFilledInput.value = '';
            confirmPricePerLitreInput.value = '';
            confirmTotalCostInput.value = '';
            confirmOdometerReadingInput.value = '';
            confirmDateInput.value = '';
            confirmTimeInput.value = '';

            fileNameDisplay.textContent = '';
            currentExtractedDetails = null;
        }

        function displayFillupDetails(fillup) {
            const locationText = fillup.petrolStationLocation ? ` (${fillup.petrolStationLocation})` : '';
            detailModalTitle.textContent = `Details for ${fillup.petrolStationName}${locationText}`;
            detailModalContent.innerHTML = `
                <p><strong>Date:</strong> ${new Date(fillup.date).toLocaleDateString()}</p>
                <p><strong>Time:</strong> ${fillup.time || 'N/A'}</p>
                <p><strong>Fuel Type:</strong> ${fillup.fuelType || 'N/A'}</p>
                <p><strong>Litres Filled:</strong> ${fillup.litresFilled.toFixed(2)} L</p>
                <p><strong>Price Per Litre:</strong> £${fillup.pricePerLitre.toFixed(3)}</p>
                <p><strong>Total Cost:</strong> £${fillup.totalCost.toFixed(2)}</p>
                <p><strong>Odometer Reading:</strong> ${fillup.odometerReading.toLocaleString()}</p>
            `;
            showModal(null, 'detail');
        }

        function promptForDelete(id) {
            fillupIdToDelete = id;
            showModal(null, 'deleteConfirm');
        }

        async function deleteFillup() {
            if (!fillupIdToDelete || !isAuthReady) return;
            try {
                await deleteDoc(doc(db, `artifacts/${appId}/users/${userId}/fillups`, fillupIdToDelete));
            } catch (error) {
                console.error("Error deleting document:", error);
                showModal("There was a problem deleting the fill-up.");
            } finally {
                hideModal('deleteConfirm');
                fillupIdToDelete = null;
            }
        }

        function renderHistoryList() {
            let sortedFillups = [...allFillups];
            switch (currentSort) {
                case 'date-asc':
                    sortedFillups.sort((a, b) => new Date(a.date) - new Date(b.date));
                    break;
                case 'total-desc':
                    sortedFillups.sort((a, b) => b.totalCost - a.totalCost);
                    break;
                case 'total-asc':
                    sortedFillups.sort((a, b) => a.totalCost - b.totalCost);
                    break;
                case 'litres-desc':
                    sortedFillups.sort((a, b) => b.litresFilled - a.litresFilled);
                    break;
                case 'litres-asc':
                    sortedFillups.sort((a, b) => a.litresFilled - b.litresFilled);
                    break;
                case 'odometer-desc':
                    sortedFillups.sort((a, b) => b.odometerReading - a.odometerReading);
                    break;
                case 'odometer-asc':
                    sortedFillups.sort((a, b) => a.odometerReading - b.odometerReading);
                    break;
                case 'date-desc':
                default:
                    sortedFillups.sort((a, b) => new Date(b.date) - new Date(a.date));
                    break;
            }

            if (sortedFillups.length === 0) {
                historyList.innerHTML = '<p class="text-center text-gray-500">No fill-ups logged yet.</p>';
                return;
            }

            historyList.innerHTML = '';
            sortedFillups.forEach(fillup => {
                const fillupEl = document.createElement('div');
                fillupEl.className = 'bg-white p-4 rounded-lg shadow-sm border border-gray-200 flex justify-between items-center';
                const locationText = fillup.petrolStationLocation ? ` (${fillup.petrolStationLocation})` : '';
                const mainContent = document.createElement('div');
                mainContent.className = 'flex-grow cursor-pointer';
                mainContent.innerHTML = `
                    <p class="font-semibold text-gray-800">${fillup.petrolStationName}${locationText}</p>
                    <p class="text-sm text-gray-500">${new Date(fillup.date).toLocaleDateString()} at ${fillup.time || ''} - ${fillup.fuelType || 'N/A'}</p>
                    <p class="text-xs text-gray-400">Odometer: ${fillup.odometerReading.toLocaleString()}</p>
                `;
                mainContent.addEventListener('click', () => displayFillupDetails(fillup));

                const totalEl = document.createElement('p');
                totalEl.className = 'text-lg font-bold text-blue-600 ml-4';
                totalEl.textContent = `£${(fillup.totalCost).toFixed(2)}`;

                const deleteBtn = document.createElement('button');
                deleteBtn.className = 'ml-4 p-2 rounded-full hover:bg-red-100 text-gray-400 hover:text-red-600 transition-colors';
                deleteBtn.innerHTML = `<svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>`;
                deleteBtn.addEventListener('click', (e) => { e.stopPropagation(); promptForDelete(fillup.id); });

                fillupEl.appendChild(mainContent);
                fillupEl.appendChild(totalEl);
                fillupEl.appendChild(deleteBtn);
                historyList.appendChild(fillupEl);
            });
        }

        function fetchAndDisplayHistory() {
            if (unsubscribeHistory) unsubscribeHistory();
            if (!isAuthReady) return;
            const fillupsCol = collection(db, `artifacts/${appId}/users/${userId}/fillups`);
            const q = query(fillupsCol);

            unsubscribeHistory = onSnapshot(q, (querySnapshot) => {
                allFillups = [];
                querySnapshot.forEach((doc) => {
                    allFillups.push({ id: doc.id, ...doc.data() });
                });
                renderHistoryList();
            }, (error) => {
                console.error("Error listening to history:", error);
                historyList.innerHTML = '<p class="text-center text-red-500">Could not load history.</p>';
            });
        }

        // --- Summary/Chart Logic ---
        function updateFilterButtons(activeFilter, buttonGroup) {
            const btns = document.querySelectorAll(buttonGroup);
            btns.forEach(btn => {
                btn.classList.toggle('bg-blue-600', btn.id === activeFilter);
                btn.classList.toggle('text-white', btn.id === activeFilter);
                btn.classList.toggle('bg-gray-100', btn.id !== activeFilter);
                btn.classList.toggle('text-gray-700', btn.id !== activeFilter);
            });
        }

        async function loadSummaryData() {
            if (!isAuthReady) return;
            const fillupsCol = collection(db, `artifacts/${appId}/users/${userId}/fillups`);
            const q = query(fillupsCol);
            const querySnapshot = await getDocs(q);
            allFillups = [];
            querySnapshot.forEach((doc) => {
                allFillups.push({ id: doc.id, ...doc.data() });
            });
            updateChart(3);
            updateFilterButtons('filter-3m', '.filter-btn');
            updateFilterButtons('chart-by-station', '.chart-toggle-btn');
        }

        function updateChart(months) {
            const cutoffDate = new Date();
            cutoffDate.setMonth(cutoffDate.getMonth() - months);

            const filteredFillups = allFillups.filter(fillup => new Date(fillup.date) >= cutoffDate);

            if (filteredFillups.length === 0) {
                noChartData.classList.remove('hidden');
                chartContainer.classList.add('hidden');
                summaryDetails.classList.add('hidden');
                if (fillupChart) fillupChart.destroy();
                return;
            }

            noChartData.classList.add('hidden');
            chartContainer.classList.remove('hidden');
            summaryDetails.classList.remove('hidden');

            const totalSpent = filteredFillups.reduce((sum, fillup) => sum + fillup.totalCost, 0);
            const totalLitres = filteredFillups.reduce((sum, fillup) => sum + fillup.litresFilled, 0);
            summaryTotalEl.textContent = new Intl.NumberFormat('en-GB', { style: 'currency', currency: 'GBP' }).format(totalSpent);
            summaryLitresEl.textContent = `${totalLitres.toFixed(2)} L`;

            let dataByGroup;

            if (currentChartType === 'fuel-type') {
                dataByGroup = filteredFillups.reduce((acc, fillup) => {
                    const fuelType = fillup.fuelType || 'Other';
                    acc[fuelType] = (acc[fuelType] || 0) + fillup.totalCost;
                    return acc;
                }, {});
            } else {
                dataByGroup = filteredFillups.reduce((acc, fillup) => {
                    const station = fillup.petrolStationName || 'Unknown Station';
                    acc[station] = (acc[station] || 0) + fillup.totalCost;
                    return acc;
                }, {});
            }

            summaryListEl.innerHTML = '';
            const sortedGroups = Object.entries(dataByGroup).sort(([, a], [, b]) => b - a);

            for (const [groupName, amount] of sortedGroups) {
                const listItem = document.createElement('div');
                listItem.className = 'flex justify-between items-center bg-gray-50 p-3 rounded-md';
                listItem.innerHTML = `
                    <span class="font-medium text-gray-800">${groupName}</span>
                    <span class="font-semibold text-gray-900">${new Intl.NumberFormat('en-GB', { style: 'currency', currency: 'GBP' }).format(amount)}</span>
                `;
                summaryListEl.appendChild(listItem);
            }

            const labels = Object.keys(dataByGroup);
            const data = Object.values(dataByGroup);

            if (fillupChart) fillupChart.destroy();

            const ctx = chartCanvas.getContext('2d');
            fillupChart = new Chart(ctx, {
                type: 'pie',
                data: {
                    labels: labels,
                    datasets: [{
                        label: `Total Cost by ${currentChartType === 'fuel-type' ? 'Fuel Type' : 'Station'}`,
                        data: data,
                        backgroundColor: labels.map((_, i) => `hsl(${(i * 50) % 360}, 70%, 60%)`),
                        hoverOffset: 4
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: { legend: { position: 'top' }, tooltip: { callbacks: { label: (c) => `${c.label}: ${new Intl.NumberFormat('en-GB', { style: 'currency', currency: 'GBP' }).format(c.parsed)}` } } }
                }
            });
        }

        // --- Event Listeners Setup ---
        function setupEventListeners() {
            loginBtn.addEventListener('click', handleLogin);
            signupBtn.addEventListener('click', handleSignUp);
            logoutBtn.addEventListener('click', handleLogout);

            homeNavBtn.addEventListener('click', () => { showMainAppScreen('home-screen'); updateNav('nav-home'); });
            historyNavBtn.addEventListener('click', () => { showMainAppScreen('history-screen'); updateNav('nav-history'); });
            summaryNavBtn.addEventListener('click', () => { showMainAppScreen('summary-screen'); updateNav('nav-summary'); });

            receiptUploadInput.addEventListener('change', handleFileUpload);

            // Event listeners for confirmation screen buttons
            cancelConfirmBtn.addEventListener('click', () => {
                resetForm();
                showMainAppScreen('home-screen');
            });
            saveConfirmedBtn.addEventListener('click', () => saveFillup());

            alertModalCloseBtn.addEventListener('click', () => hideModal('alert'));
            detailModalCloseBtn.addEventListener('click', () => hideModal('detail'));
            deleteConfirmBtn.addEventListener('click', deleteFillup);
            deleteCancelBtn.addEventListener('click', () => hideModal('deleteConfirm'));


            sortBySelect.addEventListener('change', (e) => {
                currentSort = e.target.value;
                renderHistoryList();
            });

            exportBtn.addEventListener('click', () => {
                let csvContent = "data:text/csv;charset=utf-8,Date,Time,Petrol Station,Location,Fuel Type,Litres Filled,Price Per Litre,Total Cost,Odometer Reading\n";
                allFillups.forEach(fillup => {
                    const row = [
                        fillup.date,
                        fillup.time,
                        `"${fillup.petrolStationName}"`,
                        `"${fillup.petrolStationLocation}"`,
                        `"${fillup.fuelType}"`,
                        fillup.litresFilled,
                        fillup.pricePerLitre,
                        fillup.totalCost,
                        fillup.odometerReading
                    ];
                    csvContent += row.join(",") + "\r\n";
                });
                const encodedUri = encodeURI(csvContent);
                const link = document.createElement("a");
                link.setAttribute("href", encodedUri);
                link.setAttribute("download", "fillups.csv");
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
            });

            filterBtns.forEach(btn => {
                btn.addEventListener('click', () => {
                    const months = parseInt(btn.id.split('-')[1]);
                    updateChart(months);
                    updateFilterButtons(btn.id, '.filter-btn');
                });
            });

            chartToggleBtns.forEach(btn => {
                btn.addEventListener('click', () => {
                    currentChartType = btn.id.includes('station') ? 'station' : 'fuel-type';
                    const activeFilter = document.querySelector('.filter-btn.bg-blue-600') || document.getElementById('filter-3m');
                    updateChart(parseInt(activeFilter.id.split('-')[1]));
                    updateFilterButtons(btn.id, '.chart-toggle-btn');
                });
            });

            // Auto-calculate total cost on confirmation screen (only place where manual input occurs for new entries)
            confirmLitresFilledInput.addEventListener('input', calculateTotalCostConfirmation);
            confirmPricePerLitreInput.addEventListener('input', calculateTotalCostConfirmation);
        }

        function calculateTotalCostConfirmation() {
            const litres = parseFloat(confirmLitresFilledInput.value);
            const price = parseFloat(confirmPricePerLitreInput.value);
            if (!isNaN(litres) && !isNaN(price)) {
                confirmTotalCostInput.value = (litres * price).toFixed(2);
            } else {
                confirmTotalCostInput.value = '';
            }
        }

        // --- Initialization ---
        async function initialize() {
            const app = initializeApp(firebaseConfig);
            db = getFirestore(app);
            auth = getAuth(app);
            setupEventListeners();

            onAuthStateChanged(auth, async (user) => {
                if (user) {
                    userId = user.uid;
                    isAuthReady = true;
                    authScreen.classList.add('hidden');
                    authScreen.classList.remove('active-screen');
                    mainApp.classList.remove('hidden');
                    showMainAppScreen('home-screen');
                    updateNav('nav-home');
                } else {
                    try {
                        if (typeof __initial_auth_token !== 'undefined') {
                            await signInWithCustomToken(auth, __initial_auth_token);
                        } else {
                            await signInAnonymously(auth);
                        }
                    } catch (error) {
                        console.error("Firebase anonymous sign-in failed:", error);
                        userId = null;
                        isAuthReady = false;
                        if (unsubscribeHistory) unsubscribeHistory();
                        historyList.innerHTML = '';
                        authScreen.classList.remove('hidden');
                        authScreen.classList.add('active-screen');
                        mainApp.classList.add('hidden');
                    }
                }
            });
        }

        initialize();

    </script>
</body>

</html>